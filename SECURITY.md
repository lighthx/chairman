# 安全参数过期分析

## 参数过期时间分析

### 1. 理论上会过期但实际可长期使用的参数

#### `_` (时间戳)
- **值**: `1763619048061`
- **作用**: 防止浏览器缓存
- **理论过期**: 每次请求都应该用当前时间戳
- **实际测试**: ✅ **可以长期使用**（已测试 3+ 小时仍有效）
- **是否必须**: 否

#### `h5st` (签名参数)
- **值**: `20251120141052072;g9tw6a63ahdhddt5;586ae;tk03wa5a81bdf18np...`
- **结构分析**:
  ```
  h5st[0]: 20251120141052072  // 时间: 2025-11-20 14:10:52.072
  h5st[1]: g9tw6a63ahdhddt5  // 设备/会话标识
  h5st[2]: 586ae              // 版本或类型标识
  h5st[3]: tk03wa5a81bdf18... // 加密签名（最长）
  h5st[4]: 91a5790289cc5e0... // SHA-256 哈希值
  h5st[5]: 5.2                // 算法版本
  h5st[6]: 1763619048072      // Unix 时间戳（毫秒）
  ```
- **理论过期**: 5-10 分钟（基于时间戳和签名）
- **实际测试**: ✅ **可以长期使用**（已测试 3+ 小时仍有效）
- **结论**: 京东服务器对 `h5st` 的验证可能不那么严格，或者有较长的容错时间窗口
- **是否必须**: ✅ **是**（但比预期的耐用）

---

### 2. 会自动更新的参数（无需担心过期）

#### `sdtoken` (会话令牌)
- **值**: `AAbEsBpEIOVjqTAKCQtvQu17xN-6j7JN...`
- **理论过期**: 30 分钟
- **实际情况**: ✅ **自动更新**（每次请求后服务器返回新值）
- **是否必须**: ✅ **是**（但已实现自动更新，无需手动维护）

#### `flash` (会话标识)
- **值**: `3_msei74wFj_xiv7gE1toMO8PGpkg7StsE...`
- **过期**: **约 1-24 小时**
- **是否必须**: ✅ **是**

#### `x-api-eid-token` (API 身份令牌)
- **值**: `jdd03EBSUEPAM437GW4LD7TMLOPBHP3GSZ...`
- **过期**: **约 1-24 小时**
- **是否必须**: ✅ **是**（API 认证必需）

---

### 3. 中期过期的参数（几天到几周）

#### `token` (登录令牌)
- **值**: `6b9ab92578ab9890bf6b5c72996cf411,3,979787`
- **过期**: **约 7-30 天**（取决于"记住我"设置）
- **是否必须**: ✅ **是**（登录状态的核心）

#### `3AB9D23F7A4B3CSS` (会话标识符)
- **值**: `jdd03EBSUEPAM437GW4LD7TMLOPBHP3GSZ...`
- **过期**: **约 7-30 天**
- **是否必须**: ✅ **是**

---

### 4. 长期有效的参数（几个月或永久）

#### `pin` (用户名)
- **值**: `%E8%80%81%E7%90%A6` (解码: "老琦")
- **过期**: **永久有效**（除非修改用户名）
- **是否必须**: ✅ **是**（标识用户身份）

#### `pinId` (用户 ID)
- **值**: `v66OMquyWfo`
- **过期**: **永久有效**
- **是否必须**: ✅ **是**

#### `unick` (昵称)
- **值**: `%E8%80%81%E7%90%A6_CQ` (解码: "老琦_CQ")
- **过期**: **永久有效**
- **是否必须**: ✅ **是**

#### `uuid` / `__jdu` (设备唯一标识)
- **值**: `16930457925042119771904`
- **过期**: **永久有效**（除非清除浏览器数据）
- **是否必须**: ✅ **是**（设备指纹）

#### 设备指纹 (`shshshfpa`, `shshshfpx`, `shshshfpb`)
- **过期**: **永久有效**（除非清除浏览器数据）
- **是否必须**: ✅ **是**（反爬虫需要）

#### `thor` (加密签名)
- **值**: `B8CBF9DE9B97D38188F7B3C7CF88196542AD52EC...`
- **过期**: **长期有效**（几个月）
- **是否必须**: ✅ **是**

---

### 5. 可选或通用的参数（不影响认证）

#### `areaId`, `ipLoc-djd` (地理位置)
- **过期**: 不过期，但可能根据 IP 变化
- **是否必须**: ❌ **否**（但影响商品可用性）

#### `b_dw`, `b_dh`, `b_dpr` (浏览器参数)
- **过期**: 不过期
- **是否必须**: ❌ **否**（仅用于统计）

#### `TrackID`, `__jdv` (追踪参数)
- **过期**: 不过期，但每次访问可能变化
- **是否必须**: ❌ **否**（仅用于营销追踪）

---

## 过期时间总结表（基于实际测试）

| 参数类型 | 理论过期时间 | 实际测试结果 | 是否自动更新 | 是否必须 |
|---------|------------|------------|------------|---------|
| `_` (时间戳) | 立即 | ✅ 3+ 小时仍有效 | ❌ | 否 |
| `h5st` (签名) | 5-10分钟 | ✅ 3+ 小时仍有效 | ❌ | ✅ 是 |
| `sdtoken` | 30分钟 | ✅ 自动更新 | ✅ 是 | ✅ 是 |
| `x-api-eid-token` | 1-24小时 | 未测试 | ❌ | ✅ 是 |
| `flash` | 1-24小时 | 未测试 | ❌ | ✅ 是 |
| `token` | 7-30天 | 长期有效 | ❌ | ✅ 是 |
| `3AB9D23F7A4B3CSS` | 7-30天 | 长期有效 | ❌ | ✅ 是 |
| `pin`, `pinId` | 永久 | 永久有效 | ❌ | ✅ 是 |
| `uuid`, `__jdu` | 永久 | 永久有效 | ❌ | ✅ 是 |
| 设备指纹 | 永久 | 永久有效 | ❌ | ✅ 是 |
| 地理/浏览器参数 | 不过期 | 长期有效 | ❌ | ❌ 否 |

### 重要发现

1. **`h5st` 参数比预期耐用得多**
   - 理论：5-10 分钟过期
   - 实际：已测试 3+ 小时仍然有效
   - 结论：京东的验证机制比想象中宽松，或者有较长的时间容错窗口

2. **`sdtoken` 会自动更新**
   - 每次请求后服务器返回新的 30 分钟有效期 token
   - 我们已实现自动提取和更新机制
   - 无需手动维护

3. **整体稳定性**
   - 用户反馈：**已连续运行 2+ 小时无问题**
   - 实际测试：**3+ 小时后仍正常工作**
   - 比理论分析的要稳定得多

---

## ✅ 好消息：`h5st` 参数实际上很耐用

### 之前的担心（基于理论分析）
`h5st` 是京东的**反爬虫签名参数**，理论上包含：
1. 当前时间戳
2. 请求参数的加密哈希
3. 设备和会话信息

理论上应该：
- **时间限制**：签名在 5-10 分钟内有效
- **参数绑定**：每次请求参数不同时必须重新计算
- **严格验证**：需要精确匹配

### 实际测试结果（令人惊喜）

✅ **`h5st` 参数可以长期使用！**

- **测试时长**：3+ 小时
- **请求次数**：数十次
- **不同参数**：搜索了多个不同的商品
- **结果**：✅ 全部成功

### 可能的原因

1. **时间容错窗口很大**
   - 虽然包含时间戳，但京东可能允许较大的时间偏差
   - 或者时间验证不是强制的

2. **参数验证不严格**
   - `h5st` 可能主要用于识别设备和会话
   - 对具体的请求参数（如 keyWord）验证不严格

3. **会话级别的签名**
   - `h5st` 可能是会话级别的签名，而非请求级别
   - 只要会话有效，就可以继续使用

### 实际使用建议

#### 方案 1：当前方案（推荐用于个人/测试）✅
- **直接使用**：从浏览器复制一次 `h5st`
- **持续时间**：实测可用 3+ 小时，可能更长
- **更新频率**：只在出现认证失败时更新
- **适用场景**：个人使用、低频调用、开发测试

#### 方案 2：定期更新（谨慎方案）
- **更新频率**：每天或每周更新一次（而非之前建议的 1-2 小时）
- **触发条件**：当 API 返回认证失败时
- **适用场景**：中等频率使用

#### 方案 3：使用官方 API（生产环境）⭐
- 申请京东联盟官方 API
- 使用 AppKey 和 AppSecret 进行认证
- 无需处理 Cookie 和签名问题
- 稳定可靠，适合生产环境

---

## 建议的实施方案

### 对于当前项目（短期使用）
1. ✅ 将所有 Cookie 和 URL 参数提取为环境变量
2. ✅ 定期（每 1-2 小时）手动更新 `h5st`、`sdtoken` 等短期参数
3. ✅ 监控 API 响应，当返回认证失败时提示更新 Cookie

### 对于生产环境（长期使用）
1. ⭐ **推荐**：申请京东联盟官方 API
2. 或者：逆向 h5st 算法（需要专业知识）
3. 或者：使用第三方服务（如代理池、验证码服务）

---

## Cookie 更新检测机制

建议添加错误检测，当 Cookie 过期时自动提示：

```typescript
// 示例代码（添加到 index.ts）
if (data.code === 401 || data.code === 403 || data.message?.includes('登录')) {
  throw new Error('Cookie 已过期，请更新环境变量中的认证信息');
}
```

---

## 安全建议

1. ✅ **不要将 Cookie 提交到 Git**
   - 已添加 `.env` 到 `.gitignore`

2. ✅ **定期更新敏感参数**
   - 建议每天更新一次完整的 Cookie

3. ✅ **监控异常响应**
   - 实现错误处理和自动告警

4. ⚠️ **限制 API 调用频率**
   - 避免触发京东的反爬虫机制
   - 建议每个商品查询间隔 1-2 秒

---

## ✅ 自动 Cookie 更新功能

### 已实现的功能

我们已经实现了 **自动 Cookie 更新机制**！

#### 工作原理

1. **Cookie 管理器** ([src/cookie-manager.ts](src/cookie-manager.ts))
   - 解析和存储所有 Cookie
   - 自动从响应头提取新的 token
   - 动态更新 `sdtoken`

2. **自动更新流程**
   ```
   发送请求 → 服务器返回 x-rp-sdtoken 头 → 自动解析并更新 → 下次请求使用新 token
   ```

3. **实际效果**
   ```
   🔄 Cookie 已更新: sdtoken = AAbEsBpEIOVjqTAKCQtvQu17TZmUW3Ea...
   ⏰ 新 sdtoken 将在 30 分钟后过期
   ```

#### 好处

✅ **不需要手动更新 `sdtoken`**
✅ **每次请求自动获取新的 token（30分钟有效期）**
✅ **只要 `h5st`、长期 token（如 `pin`、`uuid`）有效，就可以持续使用**

#### 仍需要手动更新的参数

⚠️ 以下参数仍需要定期手动更新（约每 1-2 小时）：
- `h5st` - 签名参数（5-10分钟有效）
- `x-api-eid-token` - API 身份令牌（1-24小时）
- 长期 Cookie（如 `token`、`pin` 等）- 只在过期或登出时需要更新

---

## 总结

### 当前状态（基于实际测试）
- ✅ `sdtoken`：**已实现自动更新**（每次请求后更新，30分钟有效期）
- ✅ `h5st`：**实测可用 3+ 小时**（比理论分析的 5-10 分钟要耐用得多）
- ✅ `pin`, `pinId`, `uuid` 等长期参数：永久有效（除非换账号）
- ✅ **整体稳定性**：用户反馈已连续运行 2+ 小时无问题

### 实际使用建议

#### 个人/测试使用（推荐）✅
- **初次配置**：从浏览器复制一次完整参数即可
- **预期使用时长**：数小时到数天（取决于会话保持）
- **更新触发**：只在 API 返回认证失败时才需要更新
- **维护成本**：极低

#### 生产环境使用 ⭐
- 建议申请京东联盟官方 API
- 使用 AppKey 和 AppSecret 认证
- 稳定可靠，无需担心 Cookie 过期

### 使用提示

1. **首次启动或 Cookie 过期时**：
   - 打开浏览器登录京东联盟
   - 打开开发者工具（F12）→ Network
   - 刷新页面，找到 `unionSearchGoods` 请求
   - 复制完整的 Cookie 和 URL 参数
   - 更新 [src/index.ts](src/index.ts) 中的 `INITIAL_COOKIE` 和 URL

2. **正常使用时**：
   - ✅ `sdtoken` 会自动更新，无需关注
   - ✅ `h5st` 可长期使用（实测 3+ 小时）
   - ✅ 只在出现认证失败时才需要重新更新

3. **判断是否需要更新**：
   - API 返回 401/403 错误
   - 或响应消息包含"登录"、"认证失败"等关键词
